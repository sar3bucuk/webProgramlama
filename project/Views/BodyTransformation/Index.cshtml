@model dynamic
@{
    ViewData["Title"] = "V羹cut Transformasyon Sim羹lat繹r羹";
    Layout = "_Layout";
    var services = ViewBag.Services as IEnumerable<proje.Models.Service> ?? new List<proje.Models.Service>();
    var member = ViewBag.Member as proje.Models.Member;
}

<div class="auth-page-modern">
    <div class="auth-stars-background"></div>
    <div class="auth-container-modern" style="max-width: 1200px;">
        <div class="auth-card-modern admin-dashboard-card">
            <div class="auth-header-modern">
                <div class="d-flex justify-content-start align-items-center mb-3">
                    <a href="@Url.Action("Index", "Member")" class="btn btn-outline-secondary back-btn-edit">
                        <i class="bi bi-arrow-left"></i> Geri D繹n
                    </a>
                </div>
                <h2 class="auth-title-modern"> AI V羹cut Transformasyon Sim羹lat繹r羹</h2>
                <p class="auth-subtitle-modern">Egzersiz program覺n覺z sonras覺 nas覺l g繹r羹neceinizi AI ile sim羹le edin</p>
            </div>

            @if (string.IsNullOrEmpty(member?.PhotoUrl))
            {
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>nce profil fotoraf覺n覺z覺 y羹kleyin!</strong> 
                    <a href="@Url.Action("Edit", "Member")" class="alert-link">Profil D羹zenle</a> sayfas覺ndan fotoraf y羹kleyebilirsiniz.
                </div>
            }

            <div class="transformation-section">
                <div class="row">
                    <div class="col-md-6">
                        <div class="transformation-form-card">
                            <h4 class="card-title">Egzersiz Program覺 Se癟in</h4>
                            
                            <form id="transformationForm">
                                @Html.AntiForgeryToken()
                                
                                <div class="form-group-modern">
                                    <label class="form-label-modern">Hizmet/Egzersiz Program覺 <span class="text-danger">*</span></label>
                                    <select id="exerciseProgram" class="form-control-modern" required>
                                        <option value="">Se癟iniz...</option>
                                        @foreach (var service in services)
                                        {
                                            <option value="@service.Name">@service.Name</option>
                                        }
                                    </select>
                                    <small class="text-muted">Veya aa覺ya 繹zel program覺n覺z覺 yazabilirsiniz</small>
                                </div>

                                <div class="form-group-modern">
                                    <label class="form-label-modern">zel Program A癟覺klamas覺</label>
                                    <textarea id="customProgram" class="form-control-modern" rows="4" 
                                              placeholder="rn: Haftada 4 g羹n a覺rl覺k antrenman覺, 2 g羹n kardiyo, g繹羹s, s覺rt, bacak, omuz odakl覺 split program..."></textarea>
                                </div>

                                <div class="form-group-modern">
                                    <label class="form-label-modern">Program S羹resi (Ay) <span class="text-danger">*</span></label>
                                    <input type="number" id="duration" class="form-control-modern" min="1" max="12" value="3" required />
                                    <small class="text-muted">1-12 ay aras覺 se癟ebilirsiniz</small>
                                </div>

                                <div class="form-group-modern">
                                    <label class="form-label-modern">Ek Notlar (Opsiyonel)</label>
                                    <textarea id="additionalNotes" class="form-control-modern" rows="3" 
                                              placeholder="rn: zellikle kar覺n kaslar覺na odaklanmak istiyorum, kilo verme hedefi var..."></textarea>
                                </div>

                                <div class="form-group-modern">
                                    <label class="form-label-modern">Fotoraf (Opsiyonel)</label>
                                    <input type="file" id="photoInput" accept="image/*" class="form-control-modern" />
                                    <small class="text-muted">
                                        @if (!string.IsNullOrEmpty(member?.PhotoUrl))
                                        {
                                            <span>Profil fotoraf覺n覺z kullan覺lacak. Farkl覺 bir fotoraf y羹klemek isterseniz se癟in.</span>
                                        }
                                        else
                                        {
                                            <span>Profil fotoraf覺n覺z yok. L羹tfen bir fotoraf y羹kleyin.</span>
                                        }
                                    </small>
                                </div>

                                <button type="submit" class="btn btn-primary w-100 mt-3" id="generateBtn">
                                    <i class="bi bi-magic"></i> Transformasyon G繹r羹nt羹s羹 Olutur
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="transformation-result-card">
                            <h4 class="card-title">Sonu癟</h4>
                            <div id="resultArea">
                                <div class="text-center text-muted py-5">
                                    <i class="bi bi-image" style="font-size: 3rem;"></i>
                                    <p class="mt-3">Egzersiz program覺n覺z覺 se癟ip "Olutur" butonuna t覺klay覺n</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(member?.PhotoUrl))
                {
                    <div class="current-photo-section mt-4">
                        <h5>Mevcut Fotoraf覺n覺z</h5>
                        <img src="@member.PhotoUrl" alt="Mevcut Fotoraf" class="current-photo-display" />
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .transformation-section {
        margin-top: 2rem;
    }

    .transformation-form-card,
    .transformation-result-card {
        background: #ffffff;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(226, 232, 240, 0.8);
        height: 100%;
    }

    .card-title {
        color: var(--text-dark);
        font-weight: 700;
        font-size: 1.25rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid rgba(226, 232, 240, 0.8);
    }

    #resultArea {
        min-height: 400px;
    }

    .transformation-image {
        width: 100%;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-top: 1rem;
    }

    .current-photo-section {
        text-align: center;
        padding: 2rem;
        background: #f8f9fa;
        border-radius: 12px;
        border: 1px solid rgba(226, 232, 240, 0.8);
    }

    .current-photo-display {
        max-width: 300px;
        max-height: 300px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-top: 1rem;
    }

    .loading-spinner {
        text-align: center;
        padding: 3rem;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3em;
    }

    .back-btn-edit {
        padding: 0.5rem 1.25rem;
        font-size: 0.9375rem;
        font-weight: 600;
        border-radius: 8px;
    }
</style>

<script>
    document.getElementById('transformationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
            const generateBtn = document.getElementById('generateBtn');
            const resultArea = document.getElementById('resultArea');
            const exerciseProgram = document.getElementById('exerciseProgram').value;
            const customProgram = document.getElementById('customProgram').value;
            const duration = parseInt(document.getElementById('duration').value);
            const additionalNotes = document.getElementById('additionalNotes').value;
            const photoInput = document.getElementById('photoInput');

            // Program se癟imi kontrol羹
            const finalProgram = customProgram.trim() || exerciseProgram;
            if (!finalProgram) {
                alert('L羹tfen bir egzersiz program覺 se癟in veya 繹zel program a癟覺klamas覺 yaz覺n.');
                return;
            }

            // Loading g繹ster
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Oluturuluyor...';
            resultArea.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Y羹kleniyor...</span>
                    </div>
                    <p class="mt-3 text-muted">Fotoraf覺n覺z analiz ediliyor ve AI g繹r羹nt羹 oluturuyor, l羹tfen bekleyin... (60-90 saniye s羹rebilir)</p>
                </div>
            `;

            try {
                const formData = new FormData();
                formData.append('exerciseProgram', finalProgram);
                formData.append('duration', duration);
                formData.append('additionalNotes', additionalNotes);
                
                // Fotoraf varsa ekle
                if (photoInput.files && photoInput.files.length > 0) {
                    formData.append('photo', photoInput.files[0]);
                }
                
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

            const response = await fetch('@Url.Action("GenerateTransformation", "BodyTransformation")', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                resultArea.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> ${data.message}
                    </div>
                    <div class="mt-3">
                        <h6>Transformasyon G繹r羹nt羹s羹 (${data.duration} Ay Sonras覺)</h6>
                        <img src="${data.imageUrl}" alt="Transformasyon G繹r羹nt羹s羹" class="transformation-image" />
                        <div class="mt-3">
                            <strong>Program:</strong> ${data.exerciseProgram}
                        </div>
                    </div>
                `;
            } else {
                resultArea.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> ${data.message}
                    </div>
                `;
            }
        } catch (error) {
            resultArea.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> Bir hata olutu: ${error.message}
                </div>
            `;
        } finally {
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="bi bi-magic"></i> Transformasyon G繹r羹nt羹s羹 Olutur';
        }
    });
</script>

