@model proje.Models.NutritionPlan
@{
    ViewData["Title"] = "Beslenme ProgramÄ± DetaylarÄ±";
    Layout = "_Layout";
}

@functions {
    // Ã–ÄŸÃ¼nleri ve genel bilgileri parse eden helper fonksiyon
    (List<(string Name, string Content, string Time)> Meals, string GeneralInfo) ParseNutritionPlan(string planDetails)
    {
        var meals = new List<(string Name, string Content, string Time)>();
        var generalInfo = new List<string>();
        
        if (string.IsNullOrEmpty(planDetails))
            return (meals, "");
        
        // Ã–ÄŸÃ¼n isimlerini tanÄ±mla (Gece yemeÄŸi hariÃ§)
        var mealKeywords = new[] { 
            "KahvaltÄ±", "Sabah", "Breakfast", "Morning",
            "Ã–ÄŸle", "Ã–ÄŸle YemeÄŸi", "Lunch", "Ã–ÄŸlen",
            "AkÅŸam", "AkÅŸam YemeÄŸi", "Dinner", "Evening",
            "Ara Ã–ÄŸÃ¼n", "Snack", "AtÄ±ÅŸtÄ±rmalÄ±k", "Ä°kindi"
        };
        
        // Genel bilgi baÅŸlÄ±klarÄ± (bunlar Ã¶ÄŸÃ¼n deÄŸil, genel bilgi)
        // "GÃ¼nlÃ¼k Ã–ÄŸÃ¼n PlanÄ±" baÅŸlÄ±ÄŸÄ±ndan sonra Ã¶ÄŸÃ¼nler baÅŸlar, bu yÃ¼zden onu genel bilgi olarak iÅŸaretleme
        var generalInfoKeywords = new[] {
            "Porsiyon MiktarlarÄ±", "Portion", "Tarif", "Recipe", "Makro Besin",
            "Ã–nemli Notlar", "Important Notes", "Dikkat Edilmesi Gerekenler",
            "Ã–neriler", "Recommendations", "ProgramÄ± Takip",
            "KiÅŸiselleÅŸtirilmiÅŸ", "Ad Soyad", "YaÅŸ", "Cinsiyet", "Boy", "Kilo",
            "Hedef", "Aktivite Seviyesi"
        };
        
        bool foundMealPlanSection = false; // "GÃ¼nlÃ¼k Ã–ÄŸÃ¼n PlanÄ±" bÃ¶lÃ¼mÃ¼nÃ¼ bulduk mu?
        
        var lines = planDetails.Split(new[] { "\n", "\r\n" }, StringSplitOptions.None);
        var currentMeal = "";
        var currentTime = "";
        var currentContent = new List<string>();
        bool inMealSection = false;
        bool inGeneralSection = false;
        var currentGeneralSection = new List<string>();
        
        foreach (var line in lines)
        {
            var trimmedLine = line.Trim();
            var originalLine = trimmedLine;
            
            // Markdown baÅŸlÄ±klarÄ±nÄ± temizle (####, ###, ##, #)
            if (trimmedLine.StartsWith("####") || trimmedLine.StartsWith("###") || 
                trimmedLine.StartsWith("##") || trimmedLine.StartsWith("#"))
            {
                trimmedLine = trimmedLine.TrimStart('#', ' ').Trim();
            }
            
            // BoÅŸ satÄ±rlarÄ± atla
            if (string.IsNullOrEmpty(trimmedLine))
            {
                if (inMealSection && currentContent.Any())
                {
                    currentContent.Add("<br>");
                }
                else if (inGeneralSection && currentGeneralSection.Any())
                {
                    currentGeneralSection.Add("<br>");
                }
                continue;
            }
            
            // "GÃ¼nlÃ¼k Ã–ÄŸÃ¼n PlanÄ±" bÃ¶lÃ¼mÃ¼nÃ¼ kontrol et
            if (trimmedLine.Contains("GÃ¼nlÃ¼k Ã–ÄŸÃ¼n PlanÄ±", StringComparison.OrdinalIgnoreCase) ||
                trimmedLine.Contains("Daily Meal Plan", StringComparison.OrdinalIgnoreCase))
            {
                foundMealPlanSection = true;
                // Bu baÅŸlÄ±ÄŸÄ± atla, Ã¶ÄŸÃ¼nler baÅŸlayacak
                continue;
            }
            
            // Genel bilgi baÅŸlÄ±ÄŸÄ± kontrolÃ¼
            bool isGeneralInfo = false;
            // EÄŸer "GÃ¼nlÃ¼k Ã–ÄŸÃ¼n PlanÄ±" bÃ¶lÃ¼mÃ¼nden sonra numaralÄ± baÅŸlÄ±k varsa (2., 3., 4., 5., 6.) genel bilgidir
            if (!foundMealPlanSection || trimmedLine.StartsWith("2.") || trimmedLine.StartsWith("3.") || 
                trimmedLine.StartsWith("4.") || trimmedLine.StartsWith("5.") || trimmedLine.StartsWith("6.") ||
                trimmedLine.StartsWith("### 2") || trimmedLine.StartsWith("### 3") || 
                trimmedLine.StartsWith("### 4") || trimmedLine.StartsWith("### 5") || trimmedLine.StartsWith("### 6"))
            {
                foreach (var keyword in generalInfoKeywords)
                {
                    if (trimmedLine.Contains(keyword, StringComparison.OrdinalIgnoreCase) && 
                        !trimmedLine.Contains("KahvaltÄ±") && !trimmedLine.Contains("Ã–ÄŸle") && 
                        !trimmedLine.Contains("AkÅŸam") && !trimmedLine.Contains("Ara Ã–ÄŸÃ¼n"))
                    {
                        isGeneralInfo = true;
                        break;
                    }
                }
            }
            
            // EÄŸer Ã¶ÄŸÃ¼n iÃ§indeyken genel bilgi baÅŸlÄ±ÄŸÄ± gÃ¶rÃ¼lÃ¼rse, Ã¶ÄŸÃ¼nÃ¼ kapat
            if (inMealSection && isGeneralInfo)
            {
                // Ã–nceki Ã¶ÄŸÃ¼nÃ¼ kaydet
                if (!string.IsNullOrEmpty(currentMeal) && currentContent.Any())
                {
                    var content = string.Join("", currentContent).Trim();
                    if (!string.IsNullOrEmpty(content))
                    {
                        meals.Add((currentMeal, content, currentTime));
                    }
                }
                currentMeal = "";
                currentContent.Clear();
                inMealSection = false;
            }
            
            // Gece yemeÄŸini kontrol et ve filtrele
            bool isNightMeal = false;
            if (trimmedLine.Contains("Gece", StringComparison.OrdinalIgnoreCase) || 
                trimmedLine.Contains("Yatmadan", StringComparison.OrdinalIgnoreCase) || 
                trimmedLine.Contains("Before Bed", StringComparison.OrdinalIgnoreCase) ||
                trimmedLine.Contains("Gece AtÄ±ÅŸtÄ±rmalÄ±ÄŸÄ±", StringComparison.OrdinalIgnoreCase))
            {
                isNightMeal = true;
            }
            
            // Ã–ÄŸÃ¼n baÅŸlÄ±ÄŸÄ± kontrolÃ¼
            bool isMealHeader = false;
            string mealName = "";
            string mealTime = "";
            
            if (!isNightMeal && !isGeneralInfo)
            {
                foreach (var keyword in mealKeywords)
                {
                    if (trimmedLine.Contains(keyword, StringComparison.OrdinalIgnoreCase))
                    {
                        isMealHeader = true;
                        
                        // TÃ¼rkÃ§e Ã¶ÄŸÃ¼n isimlerini standartlaÅŸtÄ±r
                        if (keyword.Contains("KahvaltÄ±") || keyword.Contains("Sabah") || keyword.Contains("Breakfast") || keyword.Contains("Morning"))
                            mealName = "KahvaltÄ±";
                        else if (keyword.Contains("Ã–ÄŸle") || keyword.Contains("Lunch") || keyword.Contains("Ã–ÄŸlen"))
                            mealName = "Ã–ÄŸle YemeÄŸi";
                        else if (keyword.Contains("AkÅŸam") || keyword.Contains("Dinner") || keyword.Contains("Evening"))
                            mealName = "AkÅŸam YemeÄŸi";
                        else if (keyword.Contains("Ara") || keyword.Contains("Snack") || keyword.Contains("AtÄ±ÅŸtÄ±rmalÄ±k") || keyword.Contains("Ä°kindi"))
                            mealName = "Ara Ã–ÄŸÃ¼n";
                        else
                            mealName = keyword;
                        
                        // Saat bilgisini Ã§Ä±kar
                        var timeMatch = System.Text.RegularExpressions.Regex.Match(trimmedLine, @"\((\d{1,2}:\d{2})\)");
                        if (timeMatch.Success)
                        {
                            mealTime = timeMatch.Groups[1].Value;
                        }
                        
                        break;
                    }
                }
            }
            
            if (isGeneralInfo || isNightMeal)
            {
                // Ã–nceki Ã¶ÄŸÃ¼nÃ¼ kaydet
                if (!string.IsNullOrEmpty(currentMeal) && currentContent.Any())
                {
                    var content = string.Join("", currentContent).Trim();
                    if (!string.IsNullOrEmpty(content))
                    {
                        meals.Add((currentMeal, content, currentTime));
                    }
                }
                currentMeal = "";
                currentContent.Clear();
                inMealSection = false;
                
                // Genel bilgi bÃ¶lÃ¼mÃ¼ne ekle
                inGeneralSection = true;
                var processedLine = ProcessMarkdownLine(originalLine);
                currentGeneralSection.Add(processedLine);
            }
            else if (isMealHeader)
            {
                // Ã–nceki Ã¶ÄŸÃ¼nÃ¼ kaydet
                if (!string.IsNullOrEmpty(currentMeal) && currentContent.Any())
                {
                    var content = string.Join("", currentContent).Trim();
                    if (!string.IsNullOrEmpty(content))
                    {
                        meals.Add((currentMeal, content, currentTime));
                    }
                }
                // Yeni Ã¶ÄŸÃ¼n baÅŸlat
                currentMeal = mealName;
                currentTime = mealTime;
                currentContent.Clear();
                inMealSection = true;
                inGeneralSection = false;
            }
            else if (inMealSection)
            {
                // Ã–ÄŸÃ¼n iÃ§indeyken, eÄŸer genel bilgi baÅŸlÄ±ÄŸÄ± veya genel ifade gÃ¶rÃ¼lÃ¼rse Ã¶ÄŸÃ¼nÃ¼ kapat
                bool isGeneralInMeal = false;
                
                // Genel bilgi baÅŸlÄ±klarÄ± kontrolÃ¼
                foreach (var keyword in generalInfoKeywords)
                {
                    if (trimmedLine.Contains(keyword, StringComparison.OrdinalIgnoreCase) && 
                        (trimmedLine.StartsWith("2.") || trimmedLine.StartsWith("3.") || 
                         trimmedLine.StartsWith("4.") || trimmedLine.StartsWith("5.") || 
                         trimmedLine.StartsWith("6.") || trimmedLine.StartsWith("###")))
                    {
                        isGeneralInMeal = true;
                        break;
                    }
                }
                
                // Ã–ÄŸÃ¼n iÃ§inde sadece yemek listeleri olmalÄ± - genel Ã¶neriler filtrelenmeli
                // Yemek Ã¶ÄŸesi kontrolÃ¼ - liste formatÄ±nda veya yemek iÃ§eriÄŸi iÃ§eriyorsa yemek Ã¶ÄŸesidir
                bool isFoodItem = trimmedLine.StartsWith("-") || trimmedLine.StartsWith("*");
                
                // EÄŸer liste formatÄ±nda deÄŸilse, yemek iÃ§eriÄŸi kontrolÃ¼ yap
                if (!isFoodItem)
                {
                    // Yemek iÃ§eriÄŸi kontrolÃ¼ - hem miktar hem yemek adÄ± iÃ§ermeli
                    bool hasQuantity = trimmedLine.Contains("gram") || trimmedLine.Contains("porsiyon") ||
                                      trimmedLine.Contains("su bardaÄŸÄ±") || trimmedLine.Contains("tatlÄ± kaÅŸÄ±ÄŸÄ±") ||
                                      trimmedLine.Contains("kaÅŸÄ±k") || trimmedLine.Contains("dilim") ||
                                      trimmedLine.Contains("adet") || trimmedLine.Contains("kÃ¢se");
                    
                    bool hasFoodName = trimmedLine.Contains("yumurta") || trimmedLine.Contains("ekmek") ||
                                      trimmedLine.Contains("tavuk") || trimmedLine.Contains("sebze") ||
                                      trimmedLine.Contains("meyve") || trimmedLine.Contains("yoÄŸurt") ||
                                      trimmedLine.Contains("pilav") || trimmedLine.Contains("salata") ||
                                      trimmedLine.Contains("badem") || trimmedLine.Contains("muz") ||
                                      trimmedLine.Contains("elma") || trimmedLine.Contains("armut") ||
                                      trimmedLine.Contains("brokoli") || trimmedLine.Contains("karnabahar") ||
                                      trimmedLine.Contains("enginar") || trimmedLine.Contains("kabak") ||
                                      trimmedLine.Contains("Ä±zgara") || trimmedLine.Contains("haÅŸlanmÄ±ÅŸ") ||
                                      trimmedLine.Contains("zeytinyaÄŸlÄ±") || trimmedLine.Contains("bulgur") ||
                                      trimmedLine.Contains("kinoa") || trimmedLine.Contains("yulaf") ||
                                      trimmedLine.Contains("havuÃ§") || trimmedLine.Contains("marin") ||
                                      trimmedLine.Contains("baharat") || trimmedLine.Contains("limon");
                    
                    isFoodItem = hasQuantity && hasFoodName;
                }
                
                // Genel ifadeler kontrolÃ¼ (uyarÄ±lar, dikkat edilmesi gerekenler vb.)
                // Su tÃ¼ketimi hariÃ§ - su tÃ¼ketimi kÄ±sa not olarak kalabilir
                var generalPhrases = new[] {
                    "Bu program", "hedeflerinize ulaÅŸmanÄ±zda", "doktora veya diyetisyene danÄ±ÅŸmanÄ±z",
                    "BaÅŸarÄ±lar dilerim", "saÄŸlÄ±ÄŸÄ±nÄ±zÄ± dikkate almayÄ±", "herhangi bir saÄŸlÄ±k sorununuz",
                    "Ã–ÄŸÃ¼nlerde Ã–nerilen", "Porsiyon MiktarlarÄ±", "TÃ¼rk MutfaÄŸÄ±na Uygun",
                    "Makro Besin DaÄŸÄ±lÄ±mÄ±", "Ã–nemli Notlar", "Dikkat Edilmesi Gerekenler",
                    "Ã¶zen gÃ¶sterin", "yaparak", "yapmaya", "uzak durun", "tercih edin", "deneyin",
                    "sÄ±kÄ±lmazsÄ±nÄ±z", "artÄ±rÄ±n", "ayarlayÄ±n", "koruyun",
                    "egzersiz", "spor", "yÃ¼rÃ¼yÃ¼ÅŸ", "aktif", "metabolizma", "hÄ±zlandÄ±racaktÄ±r",
                    "atlamayÄ±n", "Ã§eÅŸitli", "taze", "mevsiminde", "abur cubur", "iÅŸlenmiÅŸ",
                    "psikolojik", "motivasyon", "destek", "danÄ±ÅŸmanÄ±z", "Ã¶nemlidir"
                };
                
                // Su tÃ¼ketimi ile ilgili kÄ±sa notlar kabul edilebilir, ama uzun cÃ¼mleler deÄŸil
                bool isWaterNote = trimmedLine.Contains("su", StringComparison.OrdinalIgnoreCase) && 
                                   (trimmedLine.Contains("tÃ¼ketim") || trimmedLine.Contains("iÃ§mek") || 
                                    trimmedLine.Contains("dikkat") || trimmedLine.Contains("miktar")) &&
                                   trimmedLine.Length < 100; // KÄ±sa notlar (100 karakterden az)
                
                // EÄŸer yemek Ã¶ÄŸesi deÄŸilse ve genel ifade iÃ§eriyorsa, genel bilgi olarak iÅŸaretle
                // Su tÃ¼ketimi kÄ±sa notlarÄ± hariÃ§ (100 karakterden az)
                if (!isFoodItem && !isWaterNote)
                {
                    foreach (var phrase in generalPhrases)
                    {
                        if (trimmedLine.Contains(phrase, StringComparison.OrdinalIgnoreCase))
                        {
                            isGeneralInMeal = true;
                            break;
                        }
                    }
                    
                    // EÄŸer satÄ±r uzunsa ve yemek listesi formatÄ±nda deÄŸilse, genel bilgi olabilir
                    if (!isGeneralInMeal && trimmedLine.Length > 80 && 
                        !trimmedLine.Contains(":") && !trimmedLine.Contains("(") &&
                        !trimmedLine.Contains("gram") && !trimmedLine.Contains("porsiyon") &&
                        !trimmedLine.StartsWith("-") && !trimmedLine.StartsWith("*"))
                    {
                        isGeneralInMeal = true;
                    }
                }
                
                if (isGeneralInMeal)
                {
                    // Ã–ÄŸÃ¼nÃ¼ kapat ve genel bilgiye geÃ§
                    if (!string.IsNullOrEmpty(currentMeal) && currentContent.Any())
                    {
                        var content = string.Join("", currentContent).Trim();
                        if (!string.IsNullOrEmpty(content))
                        {
                            meals.Add((currentMeal, content, currentTime));
                        }
                    }
                    currentMeal = "";
                    currentContent.Clear();
                    inMealSection = false;
                    inGeneralSection = true;
                    var processedLine = ProcessMarkdownLine(originalLine);
                    currentGeneralSection.Add(processedLine);
                }
                else
                {
                    // Markdown listelerini ve formatlamayÄ± iÅŸle
                    var processedLine = ProcessMarkdownLine(trimmedLine);
                    currentContent.Add(processedLine);
                }
            }
            else if (inGeneralSection)
            {
                // Genel bilgi bÃ¶lÃ¼mÃ¼ne ekle
                var processedLine = ProcessMarkdownLine(trimmedLine);
                currentGeneralSection.Add(processedLine);
            }
        }
        
        // Son Ã¶ÄŸÃ¼nÃ¼ kaydet
        if (!string.IsNullOrEmpty(currentMeal) && currentContent.Any())
        {
            var content = string.Join("", currentContent).Trim();
            if (!string.IsNullOrEmpty(content))
            {
                meals.Add((currentMeal, content, currentTime));
            }
        }
        
        // Genel bilgileri birleÅŸtir
        var generalInfoText = string.Join("", currentGeneralSection).Trim();
        
        return (meals, generalInfoText);
    }
    
    // Markdown satÄ±rÄ±nÄ± HTML'e Ã§evir
    string ProcessMarkdownLine(string line)
    {
        if (string.IsNullOrEmpty(line))
            return "<br>";
        
        // Markdown bold (**text**)
        line = System.Text.RegularExpressions.Regex.Replace(line, @"\*\*(.+?)\*\*", "<strong>$1</strong>");
        
        // Markdown list item (- veya *)
        if (line.StartsWith("- ") || line.StartsWith("* "))
        {
            line = line.Substring(2);
            return "<div class='meal-item'><i class='bi bi-check-circle-fill text-success me-2'></i>" + line + "</div>";
        }
        
        // NumaralÄ± liste
        var numberedMatch = System.Text.RegularExpressions.Regex.Match(line, @"^\d+\.\s+(.+)$");
        if (numberedMatch.Success)
        {
            return "<div class='meal-item'><span class='meal-number'>" + numberedMatch.Groups[0].Value.Split('.')[0] + ".</span> " + numberedMatch.Groups[1].Value + "</div>";
        }
        
        return "<div class='meal-item'>" + line + "</div>";
    }
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">ğŸ½ï¸ Beslenme ProgramÄ± DetaylarÄ±</h3>
                    <small>OluÅŸturulma Tarihi: @Model.CreatedDate.ToString("dd.MM.yyyy HH:mm")</small>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>ğŸ“‹ Program Bilgileri</h5>
                            <table class="table table-bordered">
                                <tr>
                                    <th>Hedef:</th>
                                    <td>@(Model.Goal ?? "BelirtilmemiÅŸ")</td>
                                </tr>
                                <tr>
                                    <th>Aktivite Seviyesi:</th>
                                    <td>@(Model.ActivityLevel ?? "BelirtilmemiÅŸ")</td>
                                </tr>
                                @if (Model.DailyCalorieTarget.HasValue)
                                {
                                    <tr>
                                        <th>GÃ¼nlÃ¼k Kalori Hedefi:</th>
                                        <td><strong>@Model.DailyCalorieTarget.Value.ToString("F0") kcal</strong></td>
                                    </tr>
                                }
                                @if (Model.DailyProtein.HasValue)
                                {
                                    <tr>
                                        <th>GÃ¼nlÃ¼k Protein:</th>
                                        <td>@Model.DailyProtein.Value.ToString("F1") g</td>
                                    </tr>
                                }
                                @if (Model.DailyCarbohydrate.HasValue)
                                {
                                    <tr>
                                        <th>GÃ¼nlÃ¼k Karbonhidrat:</th>
                                        <td>@Model.DailyCarbohydrate.Value.ToString("F1") g</td>
                                    </tr>
                                }
                                @if (Model.DailyFat.HasValue)
                                {
                                    <tr>
                                        <th>GÃ¼nlÃ¼k YaÄŸ:</th>
                                        <td>@Model.DailyFat.Value.ToString("F1") g</td>
                                    </tr>
                                }
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5>âš ï¸ Ã–zel Bilgiler</h5>
                            @if (!string.IsNullOrEmpty(Model.Allergies))
                            {
                                <div class="alert alert-warning">
                                    <strong>Alerjiler:</strong> @Model.Allergies
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(Model.DislikedFoods))
                            {
                                <div class="alert alert-info">
                                    <strong>Sevilmeyen GÄ±dalar:</strong> @Model.DislikedFoods
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(Model.SpecialNotes))
                            {
                                <div class="alert alert-secondary">
                                    <strong>Ã–zel Notlar:</strong> @Model.SpecialNotes
                                </div>
                            }
                        </div>
                    </div>

                    <div class="mt-4">
                        <h5>ğŸ“ DetaylÄ± Beslenme ProgramÄ±</h5>
                        @if (!string.IsNullOrEmpty(Model.PlanDetails))
                        {
                            var result = ParseNutritionPlan(Model.PlanDetails);
                            var meals = result.Meals;
                            var generalInfo = result.GeneralInfo;
                            
                            // Genel bilgileri en Ã¼ste gÃ¶ster
                            @if (!string.IsNullOrEmpty(generalInfo))
                            {
                                <div class="card mb-4 general-info-card shadow-sm">
                                    <div class="card-header general-info-header">
                                        <h5 class="mb-0">â„¹ï¸ Genel Bilgiler ve Ã–neriler</h5>
                                    </div>
                                    <div class="card-body general-info-body">
                                        <div class="general-info-content">
                                            @Html.Raw(generalInfo)
                                        </div>
                                    </div>
                                </div>
                            }
                            
                            // Ã–ÄŸÃ¼nleri gÃ¶ster
                            @if (meals.Any())
                            {
                                // Ã–ÄŸÃ¼n sÄ±ralamasÄ± - sadece belirtilen Ã¶ÄŸÃ¼nler
                                var mealOrder = new Dictionary<string, int>
                                {
                                    { "KahvaltÄ±", 1 },
                                    { "Ara Ã–ÄŸÃ¼n", 2 },
                                    { "Ã–ÄŸle YemeÄŸi", 3 },
                                    { "AkÅŸam YemeÄŸi", 4 }
                                };
                                
                                // Ã–ÄŸÃ¼nleri sÄ±rala
                                // Ara Ã¶ÄŸÃ¼nler iÃ§in birden fazla olabilir, diÄŸer Ã¶ÄŸÃ¼nler iÃ§in sadece bir tane
                                var processedMeals = new List<(string Name, string Content, string Time)>();
                                
                                // Ara Ã¶ÄŸÃ¼nler hariÃ§, aynÄ± Ã¶ÄŸÃ¼n tipinden sadece ilkini al
                                var nonSnackMeals = meals
                                    .Where(m => mealOrder.ContainsKey(m.Name) && m.Name != "Ara Ã–ÄŸÃ¼n")
                                    .GroupBy(m => m.Name)
                                    .Select(g => g.OrderBy(m => m.Time ?? "").First())
                                    .ToList();
                                
                                // Ara Ã¶ÄŸÃ¼nlerin hepsini al (saat sÄ±rasÄ±na gÃ¶re)
                                var snackMeals = meals
                                    .Where(m => m.Name == "Ara Ã–ÄŸÃ¼n")
                                    .OrderBy(m => m.Time ?? "")
                                    .ToList();
                                
                                // TÃ¼m Ã¶ÄŸÃ¼nleri birleÅŸtir ve sÄ±rala
                                var allMeals = nonSnackMeals.Concat(snackMeals).ToList();
                                
                                // Ã–ÄŸÃ¼n sÄ±rasÄ±na gÃ¶re sÄ±rala: KahvaltÄ± -> Ara Ã–ÄŸÃ¼n(ler) -> Ã–ÄŸle -> Ara Ã–ÄŸÃ¼n(ler) -> AkÅŸam
                                var orderedMeals = new List<(string Name, string Content, string Time)>();
                                
                                // KahvaltÄ±
                                var breakfast = allMeals.FirstOrDefault(m => m.Name == "KahvaltÄ±");
                                if (!string.IsNullOrEmpty(breakfast.Name)) orderedMeals.Add(breakfast);
                                
                                // Ä°lk ara Ã¶ÄŸÃ¼nler (Ã¶ÄŸle yemeÄŸinden Ã¶nce)
                                var lunchMeal = allMeals.FirstOrDefault(m => m.Name == "Ã–ÄŸle YemeÄŸi");
                                var lunchTime = lunchMeal.Time ?? "";
                                var firstSnacks = snackMeals.Where(s => {
                                    var snackTime = s.Time ?? "";
                                    return string.IsNullOrEmpty(lunchTime) || string.Compare(snackTime, lunchTime) < 0;
                                }).ToList();
                                orderedMeals.AddRange(firstSnacks);
                                
                                // Ã–ÄŸle YemeÄŸi
                                if (!string.IsNullOrEmpty(lunchMeal.Name)) orderedMeals.Add(lunchMeal);
                                
                                // Ä°kinci ara Ã¶ÄŸÃ¼nler (Ã¶ÄŸle yemeÄŸinden sonra, akÅŸam yemeÄŸinden Ã¶nce)
                                var dinnerMeal = allMeals.FirstOrDefault(m => m.Name == "AkÅŸam YemeÄŸi");
                                var dinnerTime = dinnerMeal.Time ?? "";
                                var secondSnacks = snackMeals.Where(s => {
                                    var snackTime = s.Time ?? "";
                                    bool afterLunch = string.IsNullOrEmpty(lunchTime) || string.Compare(snackTime, lunchTime) > 0;
                                    bool beforeDinner = string.IsNullOrEmpty(dinnerTime) || string.Compare(snackTime, dinnerTime) < 0;
                                    return afterLunch && beforeDinner;
                                }).ToList();
                                orderedMeals.AddRange(secondSnacks);
                                
                                // AkÅŸam YemeÄŸi
                                if (!string.IsNullOrEmpty(dinnerMeal.Name)) orderedMeals.Add(dinnerMeal);
                                
                                @foreach (var meal in orderedMeals)
                                {
                                    <div class="card mb-4 meal-card shadow-sm">
                                        <div class="card-header meal-header">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0">
                                                    @switch (meal.Name)
                                                    {
                                                        case "KahvaltÄ±":
                                                            <span>ğŸŒ… @meal.Name</span>
                                                            break;
                                                        case "Ara Ã–ÄŸÃ¼n":
                                                            <span>ğŸ @meal.Name</span>
                                                            break;
                                                        case "Ã–ÄŸle YemeÄŸi":
                                                            <span>â˜€ï¸ @meal.Name</span>
                                                            break;
                                                        case "AkÅŸam YemeÄŸi":
                                                            <span>ğŸŒ™ @meal.Name</span>
                                                            break;
                                                        default:
                                                            <span>ğŸ½ï¸ @meal.Name</span>
                                                            break;
                                                    }
                                                </h5>
                                                @if (!string.IsNullOrEmpty(meal.Time))
                                                {
                                                    <span class="meal-time badge bg-light text-dark">
                                                        <i class="bi bi-clock"></i> @meal.Time
                                                    </span>
                                                }
                                            </div>
                                        </div>
                                        <div class="card-body meal-body">
                                            <div class="meal-content-wrapper">
                                                @Html.Raw(meal.Content)
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                            else if (string.IsNullOrEmpty(generalInfo))
                            {
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <div style="white-space: pre-wrap; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.8;">
                                            @Html.Raw(Model.PlanDetails?.Replace("\n", "<br>"))
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="card bg-light">
                                <div class="card-body">
                                    <p class="text-muted">HenÃ¼z detaylÄ± beslenme programÄ± eklenmemiÅŸ.</p>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="mt-4">
                        <a href="@Url.Action("MyPlans", "Nutrition")" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> ProgramlarÄ±m
                        </a>
                        <a href="@Url.Action("Create", "Nutrition")" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Yeni Program OluÅŸtur
                        </a>
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            <i class="bi bi-trash"></i> ProgramÄ± Sil
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Silme Onay Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle-fill"></i> Beslenme ProgramÄ±nÄ± Sil
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 1.5rem;"></i>
                    <div>
                        <strong>Dikkat!</strong> Bu iÅŸlem geri alÄ±namaz.
                    </div>
                </div>
                <p class="mb-3">
                    AÅŸaÄŸÄ±daki beslenme programÄ±nÄ± silmek istediÄŸinizden emin misiniz?
                </p>
                <div class="card bg-light">
                    <div class="card-body">
                        <strong>Program:</strong> @(Model.Goal ?? "Beslenme ProgramÄ±")<br>
                        <small class="text-muted">OluÅŸturulma: @Model.CreatedDate.ToString("dd.MM.yyyy HH:mm")</small>
                        @if (Model.DailyCalorieTarget.HasValue)
                        {
                            <br><small class="text-muted">Kalori Hedefi: @Model.DailyCalorieTarget.Value.ToString("F0") kcal</small>
                        }
                    </div>
                </div>
                <p class="text-muted mt-3 mb-0">
                    <small>Bu program silindiÄŸinde tÃ¼m bilgiler kalÄ±cÄ± olarak kaybolacaktÄ±r.</small>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Ä°ptal
                </button>
                <form asp-action="Delete" asp-controller="Nutrition" method="post" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash-fill"></i> Evet, Sil
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        border-radius: 12px;
    }
    .card-header {
        border-radius: 12px 12px 0 0 !important;
    }
    table th {
        background-color: #f8f9fa;
        width: 40%;
    }
    
    .meal-card {
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .meal-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    
    .meal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom: none;
        padding: 1.25rem 1.5rem;
    }
    
    .meal-header h5 {
        color: white;
        font-weight: 600;
        margin: 0;
        font-size: 1.25rem;
    }
    
    .meal-time {
        font-size: 0.9rem;
        padding: 0.5rem 0.75rem;
        border-radius: 20px;
    }
    
    .meal-body {
        padding: 1.5rem;
        background-color: #ffffff;
    }
    
    .meal-content-wrapper {
        line-height: 1.8;
        font-size: 1rem;
        color: #333;
    }
    
    .meal-item {
        padding: 0.75rem 0;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: flex-start;
    }
    
    .meal-item:last-child {
        border-bottom: none;
    }
    
    .meal-item i {
        margin-top: 0.25rem;
        flex-shrink: 0;
    }
    
    .meal-item .meal-number {
        font-weight: 600;
        color: #667eea;
        margin-right: 0.5rem;
    }
    
    .meal-content-wrapper strong {
        color: #667eea;
        font-weight: 600;
    }
    
    .meal-content-wrapper br {
        line-height: 1.5;
    }
    
    .general-info-card {
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .general-info-header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-bottom: none;
        padding: 1.25rem 1.5rem;
    }
    
    .general-info-header h5 {
        color: white;
        font-weight: 600;
        margin: 0;
        font-size: 1.25rem;
    }
    
    .general-info-body {
        padding: 1.5rem;
        background-color: #ffffff;
    }
    
    .general-info-content {
        line-height: 1.8;
        font-size: 1rem;
        color: #333;
    }
    
    .general-info-content .meal-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .general-info-content .meal-item:last-child {
        border-bottom: none;
    }
</style>

