<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - sar3bucuk</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
</head>
<body>
    <header class="navbar-header">
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <a class="navbar-brand" asp-area="" asp-controller="Home" asp-action="Index">
                    <span class="brand-logo">sar3bucuk</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="navbar-collapse collapse d-lg-inline-flex justify-content-between">
                    <ul class="navbar-nav flex-grow-1 justify-content-center">
                        <li class="nav-item">
                            <a class="nav-link" asp-area="" asp-controller="Home" asp-action="Index">Ana Sayfa</a>
                        </li>
                        @if (User.Identity?.IsAuthenticated == true && User.IsInRole("Admin"))
                        {
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    Admin Paneli
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="adminDropdown">
                                    <li><a class="dropdown-item" asp-controller="Gyms" asp-action="Index">üèãÔ∏è Spor Salonlarƒ±</a></li>
                                    <li><a class="dropdown-item" asp-controller="Admin" asp-action="Members">üë• √úyeler</a></li>
                                    <li><a class="dropdown-item" asp-controller="Admin" asp-action="Trainers">üë®‚Äçüè´ Antren√∂rler</a></li>
                                    <li><a class="dropdown-item" asp-controller="Admin" asp-action="Appointments">üìÖ Randevular</a></li>
                                    <li><a class="dropdown-item" asp-controller="Services" asp-action="Index">‚öôÔ∏è Hizmetler</a></li>
                                </ul>
                            </li>
                        }
                        else if (User.Identity?.IsAuthenticated == true && User.IsInRole("Trainer"))
                        {
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="trainerDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    Antren√∂r Paneli
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="trainerDropdown">
                                    <li><a class="dropdown-item" asp-controller="Trainer" asp-action="Appointments">üìÖ Randevularƒ±m</a></li>
                                    <li><a class="dropdown-item" asp-controller="Trainer" asp-action="Index">üë§ Profil</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" asp-controller="Message" asp-action="Index">üí¨ Mesajlarƒ±m</a></li>
                                </ul>
                            </li>
                        }
                        else if (User.Identity?.IsAuthenticated == true && !User.IsInRole("Admin") && !User.IsInRole("Trainer"))
                        {
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="memberDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    Hesabƒ±m
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="memberDropdown">
                                    <li><a class="dropdown-item" asp-controller="Appointment" asp-action="MyAppointments">Randevularƒ±m</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" asp-controller="Nutrition" asp-action="MyPlans">Beslenme Programlarƒ±m</a></li>
                                </ul>
                            </li>
                        }
                        else
                        {
                            <li class="nav-item">
                                <a class="nav-link" href="#services">Hizmetler</a>
                            </li>
                        }
                        <li class="nav-item">
                            <a class="nav-link" href="#contact">ƒ∞leti≈üim</a>
                        </li>
                    </ul>
                    <div class="navbar-actions">
                        @if (User.Identity?.IsAuthenticated == true)
                        {
                            var userRole = "Member";
                            if (User.IsInRole("Admin"))
                            {
                                userRole = "Admin";
                            }
                            else if (User.IsInRole("Trainer"))
                            {
                                userRole = "Trainer";
                            }
                            
                            @if (User.Identity?.IsAuthenticated == true && !User.IsInRole("Admin"))
                            {
                                <!-- Mesajlar Butonu (Bildirimlerin solunda) -->
                                <div class="messages-dropdown-wrapper d-inline-block me-2">
                                    <button type="button" class="btn btn-outline-primary position-relative" id="messagesButton">
                                        <i class="bi bi-chat-dots"></i>
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="messageBadge" style="display: none;">
                                            0
                                        </span>
                                    </button>
                                </div>
                            }

                            <!-- Bildirim Zili -->
                            <div class="notification-dropdown d-inline-block me-2" data-user-role="@userRole">
                                <button type="button" class="btn btn-outline-primary position-relative" id="notificationBell" data-bs-toggle="dropdown" aria-expanded="false">
                                    üîî
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display: none;">
                                        0
                                    </span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end notification-dropdown-menu" id="notificationDropdown" style="min-width: 350px; max-height: 500px; overflow-y: auto;">
                                    <li class="dropdown-header d-flex justify-content-between align-items-center">
                                        <span>Bildirimler</span>
                                        <button type="button" class="btn btn-sm btn-link p-0" id="markAllReadBtn" style="font-size: 0.75rem;">T√ºm√ºn√º okundu i≈üaretle</button>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li id="notificationList">
                                        <div class="text-center text-muted p-3">
                                            <p class="mb-0">Bildirim yok</p>
                                        </div>
                                    </li>
                                </ul>
                            </div>


                            @if (User.IsInRole("Trainer"))
                            {
                                @* Trainer i√ßin butonlar kaldƒ±rƒ±ldƒ±, dropdown men√ºde mevcut *@
                            }
                            else if (User.IsInRole("Admin"))
                            {
                                <a class="btn btn-outline-primary me-2" asp-controller="Admin" asp-action="Index">Admin Paneli</a>
                            }
                            else
                            {
                                <a class="btn btn-outline-primary me-2" asp-controller="Member" asp-action="Index">Profil</a>
                            }
                            <form asp-area="" asp-controller="Account" asp-action="Logout" method="post" class="d-inline">
                                <button type="submit" class="btn btn-primary">√áƒ±kƒ±≈ü Yap</button>
                            </form>
                        }
                        else
                        {
                            <a class="btn btn-outline-primary me-2" asp-area="" asp-controller="Account" asp-action="Login">Giri≈ü Yap</a>
                            <a class="btn btn-primary" asp-area="" asp-controller="Account" asp-action="Register">Kayƒ±t Ol</a>
                        }
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main role="main" class="pb-0">
        @RenderBody()
    </main>

    @if (User.Identity?.IsAuthenticated == true && (User.IsInRole("Admin") || (!User.IsInRole("Trainer"))))
    {
        <!-- Mesajlar Popup (Bildirimler gibi) -->
        <div id="messagesPopup" class="messages-popup-overlay">
            <div class="messages-popup-container">
                <div class="messages-popup-header">
                    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                        <h6 class="mb-0 fw-bold">Mesajlar</h6>
                        <div>
                            <button type="button" class="btn btn-sm btn-link text-dark p-0 me-2" id="newMessageBtn" title="Yeni Mesaj">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-link text-dark p-0" id="closeMessagesPopup" title="Kapat">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Konu≈üma Listesi G√∂r√ºn√ºm√º -->
                <div id="messagesConversationList" class="messages-conversation-list-popup">
                    <div class="text-center text-muted p-4">
                        <i class="bi bi-chat-dots fs-1 d-block mb-2 opacity-50"></i>
                        <p class="mb-0 small">Mesaj yok</p>
                    </div>
                </div>
                
                <!-- Mesaj Detay G√∂r√ºn√ºm√º -->
                <div id="messagesDetailView" class="messages-detail-view-popup" style="display: none;">
                    <div class="messages-detail-header-popup p-2 border-bottom">
                        <div class="d-flex align-items-center">
                            <button type="button" class="btn btn-sm btn-link text-dark p-0 me-2" id="backToConversationsBtn">
                                <i class="bi bi-arrow-left"></i>
                            </button>
                            <div class="flex-grow-1">
                                <h6 class="mb-0 fw-bold" id="conversationTrainerName"></h6>
                                <small class="text-muted" id="conversationTrainerStatus">Aktif</small>
                            </div>
                        </div>
                    </div>
                    
                    <div id="messagesContainer" class="messages-container-popup">
                        <!-- Mesajlar buraya y√ºklenecek -->
                    </div>
                    
                    <div class="messages-input-container-popup p-2 border-top">
                        <div class="input-group">
                            <textarea id="messageInput" class="form-control" rows="2" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." style="resize: none;"></textarea>
                            <button type="button" class="btn btn-primary" id="sendMessageBtn">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <footer class="footer-section" id="contact">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>sar3bucuk</h5>
                    <p>Modern ekipmanlar ve uzman antren√∂rlerle saƒülƒ±klƒ± ya≈üam yolculuƒüunuza bizimle ba≈ülayƒ±n.</p>
                </div>
                <div class="col-md-4">
                    <h5>Hƒ±zlƒ± Baƒülantƒ±lar</h5>
                    <ul class="footer-links">
                        <li><a href="#services">Hizmetler</a></li>
                        <li><a href="#contact">ƒ∞leti≈üim</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>ƒ∞leti≈üim</h5>
                    <p>Email: info@sar3bucuk.com</p>
                    <p>Tel: +90 (555) 123 45 67</p>
                    <p>Adres: √ñrnek Mahallesi, Spor Caddesi No:123</p>
                </div>
            </div>
            <hr class="footer-divider">
            <div class="text-center">
                <p>&copy; @DateTime.Now.Year sar3bucuk. T√ºm haklarƒ± saklƒ±dƒ±r.</p>
            </div>
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @if (User.Identity?.IsAuthenticated == true)
    {
        <script>
            $(document).ready(function() {
                function loadNotificationCount() {
                    $.get('/api/NotificationsApi/unread-count', function(data) {
                        if (data.success && data.count > 0) {
                            $('#notificationBadge').text(data.count).show();
                        } else {
                            $('#notificationBadge').hide();
                        }
                    });
                }

                function loadNotifications() {
                    $.get('/api/NotificationsApi', function(data) {
                        if (data.success && data.notifications.length > 0) {
                            var html = '';
                            var userRole = $('.notification-dropdown').data('user-role') || 'Member';
                            
                            data.notifications.forEach(function(notif) {
                                var readClass = notif.isRead ? '' : 'fw-bold';
                                var readIcon = notif.isRead ? '' : '<span class="badge bg-primary me-2">Yeni</span>';
                                var date = new Date(notif.createdDate);
                                var dateStr = date.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' + 
                                             date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                                
                                html += '<li class="notification-item ' + (notif.isRead ? '' : 'unread') + '">';
                                html += '<a class="dropdown-item" href="#" data-notification-id="' + notif.id + '" data-appointment-id="' + (notif.appointmentId || '') + '" data-user-role="' + userRole + '">';
                                html += '<div class="d-flex justify-content-between align-items-start">';
                                html += '<div class="flex-grow-1">';
                                html += '<div class="d-flex align-items-center mb-1">' + readIcon + '<span class="' + readClass + '">' + notif.title + '</span></div>';
                                html += '<small class="text-muted">' + notif.message + '</small>';
                                html += '<div class="text-muted" style="font-size: 0.75rem; margin-top: 0.25rem;">' + dateStr + '</div>';
                                html += '</div>';
                                html += '</div>';
                                html += '</a>';
                                html += '</li>';
                            });
                            $('#notificationList').html(html);
                        } else {
                            $('#notificationList').html('<div class="text-center text-muted p-3"><p class="mb-0">Bildirim yok</p></div>');
                        }
                    });
                }

                $(document).on('click', '.notification-item a', function(e) {
                    e.preventDefault();
                    var notificationId = $(this).data('notification-id');
                    var appointmentId = $(this).data('appointment-id');
                    var userRole = $(this).data('user-role');
                    
                    if (notificationId) {
                        $.post('/api/NotificationsApi/mark-read/' + notificationId, {
                            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        }, function(data) {
                            if (data.success) {
                                loadNotificationCount();
                                
                                var redirectUrl = '';
                                if (userRole === 'Admin') {
                                    redirectUrl = '@Url.Action("Appointments", "Admin")';
                                } else if (userRole === 'Trainer') {
                                    redirectUrl = '@Url.Action("Appointments", "Trainer")';
                                } else {
                                    redirectUrl = '@Url.Action("MyAppointments", "Appointment")';
                                }
                                
                                if (appointmentId) {
                                    redirectUrl += '?highlight=' + appointmentId;
                                }
                                
                                window.location.href = redirectUrl;
                            }
                        });
                    }
                });

                $('#markAllReadBtn').click(function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    $.post('/api/NotificationsApi/mark-all-read', {
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    }, function(data) {
                        if (data.success) {
                            loadNotifications();
                            loadNotificationCount();
                        }
                    });
                });

                $('#notificationBell').on('click', function() {
                    loadNotifications();
                });

                loadNotificationCount();

                setInterval(loadNotificationCount, 30000);
            });
        </script>
        @if (User.Identity?.IsAuthenticated == true && (User.IsInRole("Admin") || (!User.IsInRole("Trainer"))))
        {
            <script>
                let currentTrainerId = null;
                let messageRefreshInterval = null;
                let isAdmin = @Html.Raw(User.IsInRole("Admin") ? "true" : "false");

                function loadMessageCount() {
                    var url = isAdmin 
                        ? '@Url.Action("GetUnreadMessageCount", "Admin")'
                        : '@Url.Action("GetUnreadMessageCount", "Message")';
                    $.get(url, function(data) {
                        if (data.success && data.count > 0) {
                            $('#messageBadge, #adminMessageBadge').text(data.count).show();
                        } else {
                            $('#messageBadge, #adminMessageBadge').hide();
                        }
                    });
                }

                function loadConversations() {
                    var url = isAdmin 
                        ? '@Url.Action("GetConversations", "Admin")'
                        : '@Url.Action("GetConversations", "Message")';
                    $.get(url, function(data) {
                        if (data.success && data.conversations.length > 0) {
                            var html = '';
                            data.conversations.forEach(function(conv) {
                                var date = new Date(conv.lastMessageDate);
                                var dateStr = date.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' + 
                                             date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                                var preview = conv.lastMessage.length > 50 ? conv.lastMessage.substring(0, 50) + '...' : conv.lastMessage;
                                
                                html += '<div class="conversation-item" data-trainer-id="' + conv.otherUserId + '" data-trainer-name="' + conv.otherUserName.replace(/'/g, "&#39;") + '">';
                                html += '<div class="d-flex align-items-start">';
                                html += '<div class="flex-grow-1">';
                                html += '<div class="d-flex align-items-center mb-1">';
                                html += '<strong class="me-2" style="font-size: 0.9rem;">' + conv.otherUserName + '</strong>';
                                if (conv.unreadCount > 0) {
                                    html += '<span class="badge bg-primary" style="font-size: 0.65rem;">' + conv.unreadCount + '</span>';
                                }
                                html += '</div>';
                                html += '<p class="text-muted mb-1 small" style="font-size: 0.8rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' + preview + '</p>';
                                html += '<small class="text-muted" style="font-size: 0.7rem;">' + dateStr + '</small>';
                                html += '</div>';
                                html += '</div>';
                                html += '</div>';
                            });
                            $('#messagesConversationList').html(html);
                        } else {
                            $('#messagesConversationList').html('<div class="text-center text-muted p-4"><i class="bi bi-chat-dots fs-1 d-block mb-2 opacity-50"></i><p class="mb-0 small">Mesaj yok</p></div>');
                        }
                    });
                }

                function loadConversationMessages(trainerId, trainerName) {
                    // √ñzel chat g√∂r√ºn√ºm√ºn√º a√ß
                    currentTrainerId = trainerId;
                    $('#conversationTrainerName').text(trainerName || 'Y√ºkleniyor...');
                    
                    // Konu≈üma listesini gizle, chat detay g√∂r√ºn√ºm√ºn√º g√∂ster
                    $('#messagesConversationList').hide();
                    $('#messagesDetailView').show();

                    var url = isAdmin 
                        ? '@Url.Action("GetConversationMessages", "Admin")'
                        : '@Url.Action("GetConversationMessages", "Message")';
                    $.get(url, { trainerId: trainerId }, function(data) {
                        if (data.success) {
                            var html = '';
                            data.messages.forEach(function(msg) {
                                var date = new Date(msg.createdDate);
                                var dateStr = date.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' + 
                                             date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                                
                                var itemClass = msg.isSent ? 'sent' : 'received';
                                
                                html += '<div class="message-item ' + itemClass + '">';
                                html += '<div class="message-bubble">';
                                html += '<p>' + msg.content + '</p>';
                                html += '<small>' + dateStr + '</small>';
                                html += '</div>';
                                html += '</div>';
                            });
                            
                            $('#messagesContainer').html(html);
                            $('#messagesContainer').scrollTop($('#messagesContainer')[0].scrollHeight);
                            
                            // Auto-refresh messages
                            if (messageRefreshInterval) {
                                clearInterval(messageRefreshInterval);
                            }
                            messageRefreshInterval = setInterval(function() {
                                if (currentTrainerId && $('#messagesDetailView').is(':visible')) {
                                    loadConversationMessages(currentTrainerId, trainerName);
                                }
                            }, 5000);
                        }
                    });
                }

                // Mesajla≈ütƒ±ƒüƒ± ki≈üiye tƒ±klandƒ±ƒüƒ±nda √∂zel chat'i a√ß
                $(document).on('click', '.conversation-item', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    var $item = $(this);
                    var trainerId = $item.data('trainer-id');
                    var trainerName = $item.data('trainer-name') || $item.find('strong').text();
                    
                    // Popup'ƒ±n a√ßƒ±k olduƒüundan emin ol
                    if (!$('#messagesPopup').hasClass('active')) {
                        var button = $('#messagesButton');
                        var wrapper = button.closest('.messages-dropdown-wrapper');
                        var buttonOffset = button.offset();
                        var buttonHeight = button.outerHeight();
                        var buttonRight = $(window).width() - (buttonOffset.left + button.outerWidth());
                        
                        $('#messagesPopup').css({
                            position: 'fixed',
                            top: (buttonOffset.top + buttonHeight + 5) + 'px',
                            right: buttonRight + 'px'
                        });
                        
                        wrapper.addClass('active');
                        $('#messagesPopup').addClass('active');
                    }
                    
                    // √ñzel chat g√∂r√ºn√ºm√ºn√º a√ß
                    loadConversationMessages(trainerId, trainerName);
                });

                // Mesajlar popup a√ß/kapa - Butonun hemen altƒ±nda
                $('#messagesButton').on('click', function(e) {
                    e.stopPropagation();
                    
                    var button = $(this);
                    var wrapper = button.closest('.messages-dropdown-wrapper');
                    
                    // Popup'ƒ±n g√∂r√ºn√ºr olmasƒ± i√ßin aktif class'ƒ± ekle
                    if (wrapper.hasClass('active')) {
                        wrapper.removeClass('active');
                        $('#messagesPopup').removeClass('active');
                    } else {
                        // Diƒüer a√ßƒ±k popup'larƒ± kapat
                        $('.messages-dropdown-wrapper').removeClass('active');
                        $('#messagesPopup').removeClass('active');
                        
                        // Buton pozisyonunu al
                        var buttonOffset = button.offset();
                        var buttonHeight = button.outerHeight();
                        var buttonRight = $(window).width() - (buttonOffset.left + button.outerWidth());
                        
                        // Popup'ƒ± butonun altƒ±na, saƒüa hizalƒ± yerle≈ütir
                        $('#messagesPopup').css({
                            position: 'fixed',
                            top: (buttonOffset.top + buttonHeight + 5) + 'px',
                            right: buttonRight + 'px'
                        });
                        
                        wrapper.addClass('active');
                        $('#messagesPopup').addClass('active');
                        loadConversations();
                    }
                });
                
                // Overlay'e tƒ±klayƒ±nca kapat
                $(document).on('click', function(e) {
                    if ($('#messagesPopup').hasClass('active')) {
                        if (!$(e.target).closest('.messages-popup-container, #messagesButton, .messages-dropdown-wrapper').length) {
                            $('.messages-dropdown-wrapper').removeClass('active');
                            $('#messagesPopup').removeClass('active');
                            $('#messagesDetailView').hide();
                            $('#messagesConversationList').show();
                            currentTrainerId = null;
                            if (messageRefreshInterval) {
                                clearInterval(messageRefreshInterval);
                            }
                        }
                    }
                });
                
                // √áarpƒ± butonuna tƒ±klayƒ±nca kapat
                $('#closeMessagesPopup').on('click', function(e) {
                    e.stopPropagation();
                    $('.messages-dropdown-wrapper').removeClass('active');
                    $('#messagesPopup').removeClass('active');
                    $('#messagesDetailView').hide();
                    $('#messagesConversationList').show();
                    currentTrainerId = null;
                    if (messageRefreshInterval) {
                        clearInterval(messageRefreshInterval);
                    }
                });
                
                // Popup i√ßindeki tƒ±klamalarƒ± durdur
                $('.messages-popup-container').on('click', function(e) {
                    e.stopPropagation();
                });

                $('#backToConversationsBtn').click(function(e) {
                    e.stopPropagation();
                    $('#messagesDetailView').hide();
                    $('#messagesConversationList').show();
                    currentTrainerId = null;
                    if (messageRefreshInterval) {
                        clearInterval(messageRefreshInterval);
                    }
                    loadConversations();
                    loadMessageCount();
                });

                $('#sendMessageBtn').click(function() {
                    var content = $('#messageInput').val().trim();
                    if (!content || !currentTrainerId) {
                        return;
                    }

                    var btn = $(this);
                    btn.prop('disabled', true);
                    btn.html('<span class="spinner-border spinner-border-sm"></span>');

                    var url = isAdmin 
                        ? '@Url.Action("SendMessageToTrainer", "Admin")'
                        : '@Url.Action("SendMessage", "Message")';
                    var postData = isAdmin
                        ? {
                            trainerId: currentTrainerId,
                            content: content,
                            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        }
                        : {
                            otherUserId: currentTrainerId,
                            otherUserType: 'Trainer',
                            content: content,
                            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        };
                    $.post(url, postData, function(data) {
                        if (data.success) {
                            $('#messageInput').val('');
                            var trainerName = $('#conversationTrainerName').text();
                            loadConversationMessages(currentTrainerId, trainerName);
                            loadMessageCount();
                        } else {
                            alert(data.message || 'Mesaj g√∂nderilirken bir hata olu≈ütu.');
                        }
                        btn.prop('disabled', false);
                        btn.html('<i class="bi bi-send"></i>');
                    });
                });

                $('#messageInput').keypress(function(e) {
                    if (e.which === 13 && !e.shiftKey) {
                        e.preventDefault();
                        $('#sendMessageBtn').click();
                    }
                });

                $('#newMessageBtn').click(function() {
                    // Get available trainers
                    var url = isAdmin 
                        ? '@Url.Action("GetAvailableTrainers", "Admin")'
                        : '@Url.Action("GetAvailableTrainers", "Message")';
                    $.get(url, function(data) {
                        if (data.success && data.trainers.length > 0) {
                            var options = '<option value="">Antren√∂r se√ßin...</option>';
                            data.trainers.forEach(function(trainer) {
                                options += '<option value="' + trainer.id + '">' + trainer.name + '</option>';
                            });
                            
                            var trainerSelect = '<select id="selectedTrainerForMessage" class="form-select mb-2">' + options + '</select>';
                            var messageTextarea = '<textarea id="initialMessageText" class="form-control mb-2" rows="3" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..."></textarea>';
                            
                            var modal = $('<div class="modal fade" id="newMessageModal" tabindex="-1">' +
                                '<div class="modal-dialog"><div class="modal-content">' +
                                '<div class="modal-header"><h5 class="modal-title">Yeni Mesaj</h5>' +
                                '<button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>' +
                                '<div class="modal-body">' + trainerSelect + messageTextarea + '</div>' +
                                '<div class="modal-footer">' +
                                '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>' +
                                '<button type="button" class="btn btn-primary" id="startNewConversationBtn">G√∂nder</button>' +
                                '</div></div></div></div>');
                            
                            $('body').append(modal);
                            var bsModal = new bootstrap.Modal(document.getElementById('newMessageModal'));
                            bsModal.show();
                            
                            $('#startNewConversationBtn').click(function() {
                                var trainerId = $('#selectedTrainerForMessage').val();
                                var message = $('#initialMessageText').val().trim();
                                
                                if (!trainerId || !message) {
                                    alert('L√ºtfen antren√∂r se√ßin ve mesaj yazƒ±n.');
                                    return;
                                }
                                
                                var trainerName = $('#selectedTrainerForMessage option:selected').text();
                                
                                var url = isAdmin 
                                    ? '@Url.Action("SendMessageToTrainer", "Admin")'
                                    : '@Url.Action("SendMessage", "Message")';
                                var postData = isAdmin
                                    ? {
                                        trainerId: trainerId,
                                        content: message,
                                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                                    }
                                    : {
                                        otherUserId: trainerId,
                                        otherUserType: 'Trainer',
                                        content: message,
                                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                                    };
                                $.post(url, postData, function(data) {
                                    if (data.success) {
                                        bsModal.hide();
                                        modal.remove();
                                        loadConversations();
                                        loadMessageCount();
                                        
                                        // Open conversation in sidebar
                                        if (trainerName) {
                                            loadConversationMessages(parseInt(trainerId), trainerName);
                                        }
                                    } else {
                                        alert(data.message || 'Mesaj g√∂nderilirken bir hata olu≈ütu.');
                                    }
                                });
                            });
                            
                            $('#newMessageModal').on('hidden.bs.modal', function() {
                                modal.remove();
                            });
                        } else {
                            alert('Aktif antren√∂r bulunamadƒ±.');
                        }
                    });
                });

                loadMessageCount();
                setInterval(loadMessageCount, 30000);
            </script>
            <style>
                /* Messages Popup (Bildirimler gibi) */
                .messages-dropdown-wrapper {
                    position: relative;
                }

                .messages-popup-overlay {
                    position: fixed;
                    z-index: 1050;
                    pointer-events: none;
                    opacity: 0;
                    visibility: hidden;
                    transition: opacity 0.2s ease, visibility 0.2s ease;
                }

                .messages-popup-overlay.active {
                    pointer-events: all;
                    opacity: 1;
                    visibility: visible;
                }

                .messages-popup-container {
                    width: 400px;
                    max-height: 600px;
                    background-color: #ffffff;
                    border: 1px solid #dee2e6;
                    border-radius: 0.375rem;
                    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
                    display: flex;
                    flex-direction: column;
                    pointer-events: all;
                    overflow: hidden;
                    transform: translateY(-10px);
                    transition: transform 0.2s ease;
                }

                .messages-popup-overlay.active .messages-popup-container {
                    transform: translateY(0);
                }

                .messages-popup-header {
                    background-color: #ffffff;
                    border-bottom: 1px solid #dee2e6;
                    border-radius: 0.375rem 0.375rem 0 0;
                    flex-shrink: 0;
                }

                .messages-conversation-list-popup {
                    max-height: 450px;
                    min-height: 200px;
                    overflow-y: auto;
                    background-color: #ffffff;
                    flex: 1;
                }

                .conversation-item {
                    cursor: pointer;
                    padding: 0.75rem 1rem;
                    border-bottom: 1px solid #f1f5f9;
                    transition: background-color 0.15s;
                    display: block;
                    text-decoration: none;
                    color: inherit;
                }

                .conversation-item:hover {
                    background-color: #f8f9fa;
                    text-decoration: none;
                    color: inherit;
                }

                .conversation-item:last-child {
                    border-bottom: none;
                }

                .messages-detail-view-popup {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: #ffffff;
                    display: flex;
                    flex-direction: column;
                    border-radius: 0.375rem;
                }

                .messages-detail-header-popup {
                    background-color: #ffffff;
                    flex-shrink: 0;
                    border-radius: 0.375rem 0.375rem 0 0;
                }

                .messages-container-popup {
                    flex: 1;
                    overflow-y: auto;
                    padding: 1rem;
                    background-color: #f8f9fa;
                    min-height: 250px;
                    max-height: 350px;
                }

                .message-item {
                    margin-bottom: 0.75rem;
                    display: flex;
                    animation: fadeIn 0.2s ease-in;
                }

                .message-item.sent {
                    justify-content: flex-end;
                }

                .message-item.received {
                    justify-content: flex-start;
                }

                .message-bubble {
                    max-width: 75%;
                    padding: 0.625rem 0.875rem;
                    border-radius: 12px;
                    word-wrap: break-word;
                    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                }

                .message-item.sent .message-bubble {
                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                    color: white;
                    border-bottom-right-radius: 4px;
                }

                .message-item.received .message-bubble {
                    background: #ffffff;
                    color: #333;
                    border-bottom-left-radius: 4px;
                    border: 1px solid #e9ecef;
                }

                .message-bubble p {
                    margin: 0 0 0.25rem 0;
                    font-size: 0.875rem;
                }

                .message-bubble small {
                    font-size: 0.7rem;
                    opacity: 0.85;
                }

                .messages-input-container-popup {
                    background-color: #ffffff;
                    flex-shrink: 0;
                    border-radius: 0 0 0.375rem 0.375rem;
                }

                .messages-input-container-popup .input-group {
                    display: flex;
                    gap: 0.5rem;
                }

                .messages-input-container-popup textarea {
                    resize: none;
                    flex: 1;
                    font-size: 0.875rem;
                }

                @@keyframes fadeIn {
                    from {
                        opacity: 0;
                        transform: translateY(5px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }

                /* Scrollbar styling */
                .messages-conversation-list-popup::-webkit-scrollbar,
                .messages-container-popup::-webkit-scrollbar {
                    width: 6px;
                }

                .messages-conversation-list-popup::-webkit-scrollbar-track,
                .messages-container-popup::-webkit-scrollbar-track {
                    background: #f1f1f1;
                }

                .messages-conversation-list-popup::-webkit-scrollbar-thumb,
                .messages-container-popup::-webkit-scrollbar-thumb {
                    background: #cbd5e0;
                    border-radius: 3px;
                }

                .messages-conversation-list-popup::-webkit-scrollbar-thumb:hover,
                .messages-container-popup::-webkit-scrollbar-thumb:hover {
                    background: #a0aec0;
                }

                @@media (max-width: 768px) {
                    .messages-popup-container {
                        width: calc(100vw - 20px);
                        right: 10px;
                        max-height: calc(100vh - 80px);
                    }
                }
            </style>
        }
        <style>
            .notification-dropdown-menu {
                max-width: 400px;
            }
            .notification-item {
                border-bottom: 1px solid #e9ecef;
            }
            .notification-item:last-child {
                border-bottom: none;
            }
            .notification-item.unread {
                background-color: #f8f9fa;
            }
            .notification-item a {
                padding: 0.75rem 1rem;
                text-decoration: none;
                color: inherit;
            }
            .notification-item a:hover {
                background-color: #e9ecef;
            }
            .notification-dropdown .dropdown-header {
                padding: 0.75rem 1rem;
                font-weight: 600;
            }
            #notificationBadge {
                font-size: 0.65rem;
                padding: 0.25em 0.4em;
            }
        </style>
    }
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>

